<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Graph Viewer</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/neovis.js/dist/neovis.js"></script>
</head>
<body>
  <!-- Menu Bar with Back -->
  <div class="menu-bar">
    <div class="menu-item">
      <a href="index.html" style="color:inherit; text-decoration:none;">← Back</a>
    </div>
    <div class="menu-item">File</div>
    <div class="menu-item">Edit</div>
    <div class="menu-item">View</div>
    <div class="menu-item">Tools</div>
    <div class="menu-item">Help</div>
  </div>

  <!-- Graph Panel -->
    <div class="container" style="flex-direction: column; padding:0;">
        <div class="panel" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
        <div class="panel-header">
            <span>Neo4j Graph Viewer</span>
        </div>

        <!-- wrap your graph inside panel-content -->
        <div class="panel-content">
            <!-- full-stretch graph area -->
            <div id="neo4j-graph" style="flex:1; width:100%; height:100%;"></div>

            <!-- PROPERTY BAR -->
            <div id="prop-bar" class="hidden">
                <div id="prop-bar-close">×</div>
                <h4>Node Properties</h4>
                <div id="prop-list"></div>
            </div>
        </div>
        </div>
    </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <span id="status-message">Waiting for credentials…</span>
  </div>

  <!-- Credentials Modal -->
  <div class="modal" id="creds-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Connect to Neo4j</div>
        <div class="close-modal">&times;</div>
      </div>
      <div class="form-group">
        <label for="neo4j-uri">Bolt URI</label>
        <input type="text" id="neo4j-uri"
               placeholder="bolt://localhost:7687"
               value="bolt://localhost:7687"/>
      </div>
      <div class="form-group">
        <label for="neo4j-user">Username</label>
        <input type="text" id="neo4j-user" placeholder="neo4j" value="neo4j"/>
      </div>
      <div class="form-group">
        <label for="neo4j-password">Password</label>
        <input type="password" id="neo4j-password" placeholder="password"/>
      </div>
      <div class="modal-actions">
        <button id="cancel-creds">Cancel</button>
        <button id="confirm-creds">Connect</button>
      </div>
    </div>
  </div>

  <script>
        const statusEl = document.getElementById("status-message");
        const credsModal = document.getElementById("creds-modal");
        const closeModalBtn = credsModal.querySelector(".close-modal");
        const cancelBtn = document.getElementById("cancel-creds");
        const confirmBtn = document.getElementById("confirm-creds");
    
        function setStatus(msg) {
          statusEl.textContent = msg;
        }
        function showCreds() { credsModal.style.display = "flex"; }
        function hideCreds() { credsModal.style.display = "none"; }
    
        closeModalBtn.onclick = cancelBtn.onclick = () => {
          setStatus("Connection cancelled");
          hideCreds();
        };
    
        confirmBtn.addEventListener("click", () => {
          const uri      = document.getElementById("neo4j-uri").value.trim();
          const user     = document.getElementById("neo4j-user").value.trim();
          const password = document.getElementById("neo4j-password").value;
          if (!uri || !user || !password) {
            alert("Please fill in all fields");
            return;
          }
          hideCreds();
          renderGraph({ uri, user, password });
        });
        
        // Graph rendering logic
        async function renderGraph({ uri, user, password }) {
            setStatus("Connecting to Neo4j…");
            try {
              const config = {
                containerId:    "neo4j-graph",
                neo4j: {
                  serverUrl:      uri,
                  serverUser:     user,
                  serverPassword: password
                },
                serverDatabase: "neo4j",
                encrypted:      "ENCRYPTION_OFF",
                trust:          "TRUST_ALL_CERTIFICATES",
                labels:         {},  // leave blank for dynamic labeling
                relationships:  {},
                initialCypher:  "MATCH (n)-[r]->(m) RETURN n,r,m"
              };
        
              const viz = new NeoVis.default(config);
        
              
              // ← hook into the 'completed' event
              viz.registerOnEvent("completed", () => {
                const net    = viz.network;
                const nodes  = viz.nodes;
                const propBar    = document.getElementById("prop-bar");
                const propList   = document.getElementById("prop-list");
                const propClose  = document.getElementById("prop-bar-close");
                let pinnedNodeId = null;
          
                function showProps(nodeId, x, y) {
                  const node = nodes.get(nodeId);
                  const props = node.properties || {};
                  propList.innerHTML = ""; 
                  Object.entries(props).forEach(([k, v]) => {
                    const el = document.createElement("div");
                    el.textContent = `${k}: ${v}`;
                    propList.appendChild(el);
                  });
                  // position near top-right (or use x,y to float near cursor)
                  propBar.style.top  = "10px";
                  propBar.style.right = "10px";
                  propBar.classList.remove("hidden");
                }
          
                function hideProps() {
                  if (pinnedNodeId === null) {
                    propBar.classList.add("hidden");
                  }
                }
          
                // hover → show, blur → hide (unless pinned)
                net.on("hoverNode", params => {
                  if (pinnedNodeId === null) {
                    showProps(params.node);
                  }
                });
                net.on("blurNode", () => {
                  hideProps();
                });
          
                // click → pin/unpin
                net.on("click", params => {
                  if (params.nodes.length === 1) {
                    // clicked a node: pin it
                    pinnedNodeId = params.nodes[0];
                    showProps(pinnedNodeId);
                  } else {
                    // clicked empty space: unpin + hide
                    pinnedNodeId = null;
                    propBar.classList.add("hidden");
                  }
                });
          
                // close button to unpin
                propClose.addEventListener("click", () => {
                  pinnedNodeId = null;
                  propBar.classList.add("hidden");
                });
          
                setStatus("Graph ready!");
              });
          
              await viz.render();
        
            } catch (err) {
              console.error(err);
              setStatus("Auth error: check credentials");
              showCreds();
            }
          }
        
    document.addEventListener("DOMContentLoaded", showCreds);
</script>