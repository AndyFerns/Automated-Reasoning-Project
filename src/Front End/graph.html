<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Graph Viewer</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/neovis.js/dist/neovis.js"></script>
</head>
<body>

  <!-- Menu Bar -->
  <div class="menu-bar">
    <div class="menu-item"><a href="index.html">← Back</a></div>
    <div class="menu-item">File</div>
    <div class="menu-item">Edit</div>
    <div class="menu-item">View</div>
    <div class="menu-item">Tools</div>
    <div class="menu-item">Help</div>
  </div>

  
  <!-- Graph Panel -->
  <div class="container" style="flex-direction: column; padding:0;">
    <div class="panel" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
      <div class="panel-header"><span>Neo4j Graph Viewer</span></div>
      <div class="panel-content" style="position: relative;">
        <div id="neo4j-graph" style="flex:1; width:100%; height:100%;"></div>
        <!-- PROPERTY BAR -->
        <div id="prop-bar">
          <div id="prop-bar-close" style="cursor:pointer;">×</div>
          <h4>Properties</h4>
          <div id="prop-list"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="status-bar"><span id="status-message">Waiting for credentials…</span></div>

  <!-- CREDENTIALS MODAL -->
  <div class="modal" id="creds-modal">
    <div class="modal-content">
      <div class="modal-header"><div class="modal-title">Connect to Neo4j</div><div class="close-modal">&times;</div></div>
      <div class="form-group"><label for="neo4j-uri">Bolt URI</label><input id="neo4j-uri" value="bolt://localhost:7687"/></div>
      <div class="form-group"><label for="neo4j-user">Username</label><input id="neo4j-user" value="neo4j"/></div>
      <div class="form-group"><label for="neo4j-password">Password</label><input id="neo4j-password" type="password"/></div>
      <div class="modal-actions"><button id="cancel-creds">Cancel</button><button id="confirm-creds">Connect</button></div>
    </div>
  </div>

  <script>
    // UI helpers
    const statusEl = document.getElementById("status-message");
    const credsModal = document.getElementById("creds-modal");
    function setStatus(msg){ statusEl.textContent = msg; }
    function showCreds(){ credsModal.style.display = 'flex'; }
    function hideCreds(){ credsModal.style.display = 'none'; }

    document.querySelector('.close-modal').onclick = () => { setStatus('Cancelled'); hideCreds(); };
    document.getElementById('cancel-creds').onclick = () => { setStatus('Cancelled'); hideCreds(); };
    document.getElementById('confirm-creds').onclick = () => {
      const uri = document.getElementById('neo4j-uri').value,
            user = document.getElementById('neo4j-user').value,
            pwd  = document.getElementById('neo4j-password').value;
      if(!uri||!user||!pwd){ alert('All fields required'); return; }
      hideCreds(); renderGraph({uri,user,pwd});
    };


    async function renderGraph({uri,user,pwd}){
      setStatus('Connecting…');
      
      // neo4j configuration
      const config = {
        containerId: 'neo4j-graph',
        neo4j: { serverUrl:uri, serverUser:user, serverPassword:pwd },
        serverDatabase: 'neo4j', encrypted: 'ENCRYPTION_OFF', trust:'TRUST_ALL_CERTIFICATES',
        labels: { 
          '*': { caption:'type'} 
        },
        labels: { 
          'Entity': { caption:'name', 
          title_properties:['name', 'type'] } 
        },
        relationships: { 
          '*': { 
            caption:'type', 
            thickness:'weight', 
            value:'id'} 
        },
        visConfig: {
          nodes: {
            shape: 'dot',
            size: 25,
          },
          edges: {
            arrows: { to: { enabled: true } },
            smooth: {} //enabled: true, type: 'curvedCW', roundness: 0.25 
          },
          physics: { stabilization: true }
        },

        initialCypher: `
        MATCH (n)-[r]->(m)
        RETURN n, r, m, id(r) AS id
        UNION
        MATCH (n)<-[r]-(m)
        RETURN n, r, m, id(r) AS id
      `
      //initialCypher: 'MATCH (n)-[r]-(m) RETURN n,r,m'
      };

      const viz = new NeoVis.default(config);
      viz.registerOnEvent('completed', ()=>{
        const net = viz.network, nodes = viz.nodes, edges = viz.edges;
        const propBar = document.getElementById('prop-bar'), list = document.getElementById('prop-list');
        let pinned = null;

        function showProps(raw){
          list.innerHTML = '';
          // show labels/types
          if(raw.labels) raw.labels.forEach(l=>{ let d=document.createElement('div'); d.textContent='Label: '+l; list.appendChild(d); });
          if(raw.type) { let d=document.createElement('div'); d.textContent='Type: '+raw.type; list.appendChild(d); }
          // all properties
          Object.entries(raw.properties||{}).forEach(([k,v])=>{
            let d=document.createElement('div'); d.textContent=`${k}: ${v}`; list.appendChild(d);
          });
          propBar.style.display='block';
        }
        function hideProps(){ if(!pinned) propBar.style.display='none'; }

        net.on('hoverNode', params=>{ if(!pinned){ const n=nodes.get(params.node); showProps(n.raw||n);} });
        net.on('blurNode', ()=>hideProps());
        net.on('click', params=>{
          if(params.nodes.length===1){ pinned=params.nodes[0]; const n=nodes.get(pinned); showProps(n.raw||n);} 
          else if(params.edges.length===1){ pinned='e'; const e=edges.get(params.edges[0]); showProps(e.raw||e);} 
          else { pinned=null; hideProps(); }
        });
        document.getElementById('prop-bar-close').onclick = ()=>{ pinned=null; hideProps(); };
        setStatus('Graph ready!');
      });
      try{ await viz.render(); }
      catch(e){ console.error(e); setStatus('Error'); showCreds(); }
    }
    document.addEventListener('DOMContentLoaded', showCreds);
  </script>
</body>
</html>
